// emscripten-v3.1.0が出力したファイルをバンドルした".mjs"ファイルを、nodeから読み込もうとするとエラーになるので、
// https://github.com/emscripten-core/emscripten/issues/11792#issuecomment-877120580 に記載のワークアラウンドで対処している。
//
// TODO: emscripten側に正式な対応が入ったら、そちらを使用してこのワークアラウンドは消す
import { createRequire } from "module";
globalThis.__dirname = "dist/";
globalThis.require = createRequire(import.meta.url);

import { Rnnoise } from "../dist/rnnoise";

test("Create instance and process a frame (non SIMD)", async () => {
  const rnnoise = await Rnnoise.load({ wasmFileName: "rnnoise.wasm" });
  const denoiseState = rnnoise.createDenoiseState();
  const buffer = new Float32Array(TEST_FRAME);
  const vad = denoiseState.processFrame(buffer);
  denoiseState.destroy();

  expect(vad).toBeCloseTo(0.43759429454803467);
  buffer.forEach((x, i) => expect(x).toBeCloseTo(TEST_FRAME_PROCESSED[i]));
});

test("Create instance and process a frame (SIMD)", async () => {
  const rnnoise = await Rnnoise.load({ wasmFileName: "rnnoise_simd.wasm" });
  const denoiseState = rnnoise.createDenoiseState();
  const buffer = new Float32Array(TEST_FRAME);
  const vad = denoiseState.processFrame(buffer);
  denoiseState.destroy();

  expect(vad).toBeCloseTo(0.43759429454803467);
  buffer.forEach((x, i) => expect(x).toBeCloseTo(TEST_FRAME_PROCESSED[i]));
});

// -1000~1000の範囲でランダムに生成したテストデータ
const TEST_FRAME = [
  503.43773578783157, -974.0518320719056, 591.9538903232622, -348.18884814468106, -237.53919220308023,
  -620.8226794890326, -848.3189421437809, -840.3330290289213, -890.8740002305475, -504.56643484190454,
  -689.5074915960755, 57.29931214745261, -70.01068997682228, -125.33363302157795, 794.7318845015532, 195.8592706066513,
  -34.69984610246763, 203.57306900240633, 536.9340874113448, -813.9519346724096, -725.6171012542736, 605.3522463048882,
  -626.9407609453085, -52.587045649994366, 11.309465676496075, 326.9490706218162, 989.0594440943603, -5.0758999211522,
  318.29829527801076, -619.3549269981531, 481.11740951339175, 49.75412203564042, 745.8370892106573, 153.39716780959498,
  219.8086801382144, 901.1936700368531, 943.7931036745754, 27.049072383033717, -265.01664961731205, 829.5190619667364,
  -863.1161663708613, -488.31106232107777, -44.46213991344018, 141.22407061876925, -650.0343430764801, 688.774930770139,
  -763.0146898164629, 235.58147509013634, 528.6445904578572, -398.6268957215975, -30.07762068790032, -538.5113852133331,
  -837.6422526835245, 516.4042858524233, 550.446002703776, -911.5955877134245, 746.7372177610719, -618.1010195828178,
  -142.598432786442, 443.3924802589954, -570.1694335596626, 713.4271955464828, -600.3513959153929, -621.7863714683134,
  885.9794306735803, -345.51225530208046, 553.1076574866051, -767.135590029695, 488.7522832621844, -51.59681149136679,
  124.57083771481985, 278.06324683064554, 346.56014907001463, 282.5710266915819, 166.00006906649287, -500.2596806673918,
  469.6467915947135, 259.75102636602855, -646.1005119161532, -12.56693231376471, 89.43835087257776, 224.66788441990798,
  35.51418112741635, 109.2885491110028, 977.7538095282553, -352.6188247908175, -673.5665537055082, 614.1417129585709,
  -193.60711202928792, 729.717528249311, 501.33281416486693, 341.8974035519018, 231.43627073034895, 664.2756565138179,
  803.671889458245, -472.4631806921125, -550.0382696639283, 532.5999837331906, -38.03055284682148, 443.3299781196872,
  413.27879264411354, 735.7106389275555, -136.096551389473, -241.71097800145594, 549.6439492007214, -368.1144815128737,
  339.6528966582448, -265.0647510221655, 964.7449038509126, 283.27379886945596, -787.330140418331, 686.3562324167647,
  137.78480121569578, 793.1627752248778, 633.0294236797849, -757.5964605895351, -971.0396304073405, -806.6127028347787,
  -507.2715062462516, 318.95816395822703, 251.80406389693144, 271.96399949937154, -41.93110028189699,
  -219.09059966200653, 578.3276098455487, -990.1909673787135, 365.7070758500854, 421.5850732099527, -44.24182618881491,
  -494.1970903860204, -474.6257291995337, 526.1132188228446, 727.2934676985892, -518.6955109879965, -819.2538020870293,
  171.05897425953117, 34.91428604533644, -256.6160147487118, 930.3530184263436, -553.0324569297078, 517.8294284369745,
  -337.0434150319687, 538.1180780579189, -748.180147458118, 508.2904870578361, -924.603611172571, 698.4190936281318,
  928.4563107486522, -15.399361167533584, -254.13375266138985, 483.2838477053972, 245.07248429576703,
  -154.87924822918876, 105.7849566339296, -37.51454684675832, -872.8116505175408, -242.08611053067125,
  -434.79587648059464, -850.7143970320897, 664.6073197207086, 925.3088645978964, -894.7837059741532, -691.2279154945418,
  -73.58350222221338, -746.0712935008278, 491.03413222827226, 652.0833484124009, -627.1284364093361, 983.666111472987,
  -852.2312358166839, 916.0014888958071, -635.2584509726362, 671.7849424295096, -232.39085671638304, 912.044733349466,
  439.51526814240424, 903.2471346875836, -365.43910508334386, -336.97157378527584, -295.8283243927575,
  113.76250666101737, 437.442654668424, -801.1496295270475, 950.8704580838516, 925.9167033607548, 477.63619994563714,
  954.1357528690758, -865.2158389192291, -624.4078326545119, 961.2819016029521, 41.48268187161921, -638.6603336148571,
  -213.78445314746307, 413.73174959228027, -963.8255935756264, -636.9509583917041, 577.2744707078195,
  -773.5792298417466, 195.51894745999516, -94.58664299483564, -706.5518144123744, 375.4528035404942, 57.78795337186739,
  -866.2622665260968, 944.3864681628495, 927.81677605611, -924.5254709625683, -807.8692915167329, 840.0031644194319,
  -376.4274495927873, -655.9209255115027, 444.14071190093705, -615.6717981786371, 342.3746681859682, 491.17924320294037,
  -359.81634882517153, 836.9944342336953, -513.2054976124596, 675.7434138301783, -31.85673970260791, 413.1543853401363,
  -884.9982802642973, -389.3728518589221, -890.6974542800895, 584.6783832327978, 600.7022016900949, 963.9135173207055,
  346.7246623271533, -88.46163477607956, -562.1605516544115, -406.22115693179217, 77.89335962978726, 896.3232842048301,
  852.3537524601038, -534.9315487873862, 193.74697052445867, -261.38705735166013, 204.50795289339567, 52.31879560522566,
  -114.14833713441203, -235.60975168130653, -966.3670641482431, -780.0566286173247, 711.7406518571497,
  943.7793765252825, 628.4050980395186, -524.0143818355882, 7.641241372284185, 753.0629657689767, 881.5709152736731,
  492.61256130546394, 898.32459636663, 641.9134901175903, 269.2340701747189, 488.74734173322963, -594.4525103085209,
  604.1044099454762, -112.98279508407359, -9.793182306902168, 472.4806521597368, -76.57252758892946, -885.6892979246014,
  -263.6713717339974, -184.80190717279686, -863.7989248809299, 882.8009914593015, -889.0769637231002,
  -883.9254368780356, -862.533457951141, 493.2453680476144, 946.8105340466357, 486.40651364982864, 619.8475431211057,
  392.7137525719579, -7.496725505464269, 239.74266330328146, 946.8563663685547, 709.597663894627, -483.18267373849073,
  799.3294756926582, 674.7842562963285, 568.9736862475888, -716.540769019487, 967.8773478721289, 931.8362955940756,
  561.242346025957, 24.663941284076373, -750.9246883736178, 14.090538514590207, 819.5973651588895, 55.43306000103553,
  482.10252581560144, 234.67747688821078, 705.2079154500159, -357.3920133284813, -797.1681428075439, -737.0252825301145,
  -256.6269411399031, 977.5406432746356, 48.51805546167361, 812.4280955119741, -193.6787377928249, 966.9263610290016,
  741.8417079120509, -742.407918016125, -248.5077322136284, -634.4231194079816, -182.9223292329649, -62.35683572760183,
  902.6565187679034, -733.5350228008956, -832.4740742436929, -851.1481913206062, -93.36558081384055, -654.0215490259429,
  757.593297108861, -973.8984098149476, 120.03923148010153, 331.8597846349203, 45.505702216634745, -815.4844347497012,
  -710.7817671333592, 299.7138873404256, 167.6401241957269, -269.6929568034541, -867.3854500371067, 704.4388776330077,
  -603.9054379829021, 936.2966812202926, -753.1634498733961, -568.0090630430108, 815.453461126358, -705.1936417868619,
  328.3986397618969, -20.159654187316164, -401.35201888830886, 464.69906167074987, 425.1806166608251, 960.579002717308,
  -70.02332510139126, -492.42275792863, 755.1002473135316, 406.252902375594, -647.4938302238857, -482.97512887683206,
  440.61257298117107, 590.5406690872048, -198.1394424694214, 475.2586030543714, 62.88040039568682, 803.0703212415444,
  449.37425108855587, -91.06043783402583, 216.94476820740942, -857.6099346379738, -668.1110509052171, 887.545906797716,
  360.86091348617015, -886.2969996102777, 991.3849382700214, -69.86547401408757, -966.927275715721, -47.91634253686232,
  131.18217297283377, -559.2429203288777, -551.8238309415615, 700.2322448082648, -787.6153828803789, -974.6554660835354,
  306.86013705596656, 910.2909565879168, -181.44278122710398, -480.32741911870323, 629.3986376914509,
  -284.0738992382394, -247.84022035554074, 432.4168677917269, -708.1780359489912, -930.053453271829, -608.3488296860637,
  -306.382869815454, 868.1375695783584, -547.1611627949851, 96.55709253888085, -159.444710085574, 259.0899049483769,
  -353.8327130388501, -865.3633935681953, -263.04822452141514, 406.17917582738255, 933.1143025732074,
  384.89823228197815, 339.42210430629234, -793.7900295912581, 323.8871144438335, 716.4008444130541, 488.6099561001258,
  254.75341851571625, -23.734228148107604, -830.4429402137656, -310.24747450542975, 469.79955692421004,
  -779.878940830137, 123.8152920841469, -505.8440353712568, -526.5642887837221, 65.70973583934938, -678.7487978292261,
  650.5491669518583, -869.0611270076319, -594.3602830823573, -167.83066394058915, 224.241111483326, -294.03807865476494,
  -604.2893558274457, 210.39513059092587, 718.5671344511868, -810.1070612977733, -982.2130185368796,
  -266.38378361337755, -106.9370888575072, -465.6730854881441, -561.2060255106144, -999.1785641002555,
  -801.1767808607824, -191.58103771257686, 673.7319374034316, -626.5584162122386, 846.6923664776382, -687.2149345827407,
  461.41475641477746, -123.385213151848, -622.2920378821794, 599.272840481686, -908.0058087696094, 290.73340959186726,
  -209.11333818881485, -695.4268094875686, -120.88438279865852, -568.8746925140815, -60.84047129111127,
  -866.981883165686, -148.78559880295916, 617.4340417415835, 876.4452253692148, -274.60743878933647, 537.7388881374447,
  -897.5809334219995, -375.9921445763064, -535.0544083171837, -507.6774113190512, 174.92314283790142, 812.4003611815433,
  380.08606562862474, -332.5369317448767, 976.6568663531536, -918.8707170807637, -669.9957224030845, 442.23846714032743,
  870.5894538630262, 341.6626462997374, -687.0790421376039, -434.93858718279625, -687.7209354836544, 643.1252567657791,
  522.4043880450108, -683.7934715835117, 899.1833304672864, 822.7363361557855, 277.5894145811508, 671.2724718438471,
  -293.730561566073, 987.9561000246138, 117.90126279213587, -482.0745813419056, 999.7438813417714, 958.6391851875783,
  942.3960443865255, 451.91844821418977, -917.1076331591244,
];

const TEST_FRAME_PROCESSED = [
  0.00002133590169250965, 0.00020196176774334162, 0.0002546610194258392, 0.001149028423242271, 0.0004635318764485419,
  0.0016530649736523628, 0.0010062044020742178, -0.0004416178271640092, 0.0014007106656208634, -0.004303420428186655,
  0.0005303100915625691, -0.006247588433325291, -0.00535125657916069, -0.0027671975549310446, -0.011325329542160034,
  0.0011492172488942742, -0.014329440891742706, -0.0016505277017131448, -0.003972780425101519, -0.007878812029957771,
  0.009902377612888813, -0.013838179409503937, 0.015913967043161392, -0.004734293092042208, 0.0039977277629077435,
  0.016217727214097977, -0.011982440948486328, 0.027601806446909904, -0.017372027039527893, 0.015071853995323181,
  0.0031667142175137997, -0.012865993194282055, 0.03032962791621685, -0.027355587109923363, 0.03825845196843147,
  -0.011660070158541203, 0.0019675500225275755, 0.031856607645750046, -0.018253954127430916, 0.07056361436843872,
  -0.013264973647892475, 0.047179486602544785, 0.021373888477683067, -0.01739923097193241, 0.05432876944541931,
  -0.061693403869867325, 0.04499449580907822, -0.04224507883191109, -0.02727445214986801, 0.009533004835247993,
  -0.10053620487451553, 0.025561755523085594, -0.11634226143360138, -0.008895698934793472, -0.02717411518096924,
  -0.07279940694570541, 0.06352944672107697, -0.0960150882601738, 0.08763086795806885, -0.020946793258190155,
  0.014282535761594772, 0.08977493643760681, -0.05756603926420212, 0.1442040354013443, -0.06515409797430038,
  0.06989262253046036, 0.02574756368994713, -0.06750665605068207, 0.11222600936889648, -0.14337217807769775,
  0.07417741417884827, -0.10529966652393341, -0.07701407372951508, 0.03391358256340027, -0.16544854640960693,
  0.12453148514032364, -0.1492571234703064, 0.04466170445084572, 0.014730103313922882, -0.09996258467435837,
  0.1705990880727768, -0.13632704317569733, 0.1918731927871704, -0.00290491571649909, 0.0379914790391922,
  0.17399315536022186, -0.1200496107339859, 0.25195467472076416, -0.09852240234613419, 0.14398998022079468,
  0.10588952153921127, -0.07711116969585419, 0.2480948269367218, -0.17217980325222015, 0.21452178061008453,
  -0.04529358446598053, -0.005445953458547592, 0.18933521211147308, -0.18657512962818146, 0.2689882516860962,
  -0.20453116297721863, 0.0432119145989418, -0.013841238804161549, -0.26720210909843445, 0.12236286699771881,
  -0.43347784876823425, 0.0029839077033102512, -0.33202651143074036, -0.30501502752304077, -0.05067310482263565,
  -0.5200595855712891, 0.06323949992656708, -0.45638638734817505, -0.10488235950469971, -0.07831579446792603,
  -0.3059321343898773, 0.28907856345176697, -0.2493383288383484, 0.4004608988761902, 0.09962493926286697,
  0.1610080897808075, 0.518536388874054, -0.021413998678326607, 0.7161838412284851, 0.12574756145477295,
  0.4954952597618103, 0.47071030735969543, 0.07514306157827377, 0.6508062481880188, -0.15221306681632996,
  0.4513697922229767, -0.019076744094491005, -0.07699324935674667, 0.269864559173584, -0.49727514386177063,
  0.23588567972183228, -0.546152651309967, -0.18853655457496643, -0.20539714395999908, -0.6735925674438477,
  0.024553580209612846, -0.9004477858543396, -0.1752273142337799, -0.6524627804756165, -0.7073411345481873,
  -0.2351153939962387, -1.0832796096801758, -0.17843124270439148, -1.006884217262268, -0.5745833516120911,
  -0.5316158533096313, -1.0228325128555298, -0.08310410380363464, -1.0091196298599243, -0.053842686116695404,
  -0.43823346495628357, -0.3904452621936798, 0.3618886470794678, -0.4053122103214264, 0.8243705034255981,
  0.05928102135658264, 0.6443535089492798, 0.7873026728630066, 0.20722272992134094, 1.2477678060531616,
  0.09773620218038559, 1.0391892194747925, 0.4971494972705841, 0.3080241084098816, 0.8950937390327454,
  -0.33229199051856995, 0.7052550315856934, -0.4295712113380432, -0.014515413902699947, 0.01016117725521326,
  -0.8278168439865112, 0.24837800860404968, -1.121056079864502, -0.1352565586566925, -0.7047857642173767,
  -0.9132683873176575, -0.12873674929141998, -1.3620566129684448, -0.03642348200082779, -1.1440619230270386,
  -0.5878456234931946, -0.37177255749702454, -1.1746141910552979, 0.23115207254886627, -1.1277494430541992,
  0.058244965970516205, -0.4057377874851227, -0.5191662311553955, 0.5627909898757935, -0.6409303545951843,
  0.9943211078643799, -0.07388956844806671, 0.6091944575309753, 0.9731175899505615, 0.060167089104652405,
  1.6232537031173706, 0.1253843903541565, 1.3750015497207642, 0.8261591196060181, 0.47799035906791687,
  1.4255201816558838, -0.2390170842409134, 1.2696300745010376, -0.1450648307800293, 0.2835342586040497,
  0.46550557017326355, -0.860869824886322, 0.6117488741874695, -1.230453372001648, -0.06145233288407326,
  -0.7049526572227478, -1.116426706314087, 0.0594741627573967, -1.6718413829803467, 0.0766378790140152,
  -1.3454428911209106, -0.8247284889221191, -0.37903016805648804, -1.6463825702667236, 0.17694179713726044,
  -1.6451908349990845, -0.25993436574935913, -0.7711033821105957, -1.1319024562835693, 0.3285124599933624,
  -1.4705206155776978, 0.5476218461990356, -0.8095313906669617, -0.1864841878414154, 0.4725574254989624,
  -0.8289318084716797, 1.299331545829773, -0.503281831741333, 1.0892387628555298, 0.6214330196380615,
  0.10715359449386597, 1.662022590637207, -0.3857038617134094, 1.7239853143692017, 0.23665541410446167,
  0.6954362988471985, 1.266558289527893, -0.4310622215270996, 1.5863282680511475, -0.6628167033195496,
  0.7459436655044556, 0.1202988475561142, -0.6182551980018616, 1.0535062551498413, -1.2591090202331543,
  0.9064269065856934, -0.637205958366394, -0.11392228305339813, 0.7514349818229675, -0.9007720351219177,
  1.4924986362457275, -0.7442256808280945, 0.8827698230743408, 0.4194730520248413, -0.3904268741607666,
  1.492538571357727, -1.0284700393676758, 1.1756583452224731, -0.5882025957107544, -0.36789652705192566,
  0.31021562218666077, -1.7925148010253906, 0.6063950657844543, -1.9276326894760132, -0.3697464168071747,
  -0.8650686144828796, -1.8471266031265259, 0.33614104986190796, -2.147773265838623, 0.4595138430595398,
  -1.0527187585830688, -0.5691636800765991, 0.5428690910339355, -1.4901798963546753, 1.3644431829452515,
  -1.0860791206359863, 0.7579315900802612, 0.5865742564201355, -0.3972107470035553, 2.0186233520507812,
  -0.7087298631668091, 1.9655009508132935, 0.4063046872615814, 0.9130268692970276, 2.284848213195801,
  0.10241477191448212, 3.222562789916992, 0.6375468969345093, 2.4672446250915527, 2.321892738342285, 1.0814958810806274,
  3.6144485473632812, 0.5799012184143066, 3.202463388442993, 1.2733312845230103, 1.2942529916763306, 2.419846534729004,
  -0.4404805898666382, 2.4620227813720703, -0.7543435096740723, 0.5392036437988281, -0.014646640047430992,
  -1.8440903425216675, 0.6245461106300354, -2.7969651222229004, -0.07971823215484619, -2.015733480453491,
  -1.9711462259292603, -0.4248445928096771, -3.290496349334717, 0.20624971389770508, -2.6385018825531006,
  -0.7482302188873291, -0.5895465016365051, -2.0866997241973877, 1.0722548961639404, -2.186216354370117,
  1.1320912837982178, -0.3986336588859558, -0.11603878438472748, 1.9669321775436401, -1.0068864822387695,
  2.8137764930725098, -0.14242663979530334, 1.7145259380340576, 1.938608169555664, 0.16127526760101318,
  3.5096216201782227, -0.2692493200302124, 2.809645414352417, 0.7245430946350098, 0.2418985664844513, 2.056727886199951,
  -1.7563246488571167, 1.7539995908737183, -1.9417222738265991, -0.6680077314376831, -0.8327906727790833,
  -3.31337308883667, 0.06866832077503204, -4.213381290435791, -0.9874449372291565, -2.9227983951568604,
  -3.3701047897338867, -0.8645339012145996, -4.491003036499023, -0.002908942522481084, -3.0426220893859863,
  -0.9108985066413879, -0.12477884441614151, -2.2666244506835938, 2.1824584007263184, -1.7970380783081055,
  2.2389488220214844, 0.8962517976760864, 0.5491555333137512, 3.535311698913574, -0.6123691201210022,
  3.8300623893737793, -0.005664426367729902, 1.4148828983306885, 1.6842041015625, -1.6993958950042725,
  2.3541433811187744, -3.0111489295959473, 0.18050946295261383, -1.9800208806991577, -3.3158178329467773,
  -0.39456719160079956, -5.366103649139404, -0.7494815587997437, -4.962661266326904, -3.5505943298339844,
  -2.738050937652588, -6.299667835235596, -1.1181704998016357, -6.263086318969727, -2.16949200630188,
  -3.499727487564087, -4.470386505126953, -0.21600189805030823, -4.845988750457764, 1.41652512550354,
  -1.8966875076293945, 0.5647677183151245, 2.926410436630249, -0.33087125420570374, 6.521005153656006,
  1.699014663696289, 6.60888671875, 5.699893951416016, 4.162571907043457, 8.645013809204102, 2.3309195041656494,
  8.087416648864746, 3.0549116134643555, 3.7229902744293213, 4.98847770690918, -1.1808995008468628, 4.364151477813721,
  -3.354621410369873, -0.27531182765960693, -2.7102856636047363, -6.230360507965088, -1.6498826742172241,
  -9.671597480773926, -3.2982964515686035, -8.487812995910645, -7.606367588043213, -4.28117036819458,
  -10.083404541015625, -1.2874891757965088, -7.444300174713135, -1.419448971748352, -0.7184637784957886,
  -2.362483024597168, 6.79640007019043, 0.20194752514362335, 10.409568786621094, 7.200242042541504, 9.051630973815918,
  14.965375900268555, 8.064953804016113, 18.830392837524414, 11.250187873840332, 16.773883819580078, 16.614452362060547,
  10.8574800491333, 19.46913719177246, 6.991787910461426, 14.668352127075195, 7.0633673667907715, 2.9900848865509033,
  6.354732036590576, -8.625226020812988, -0.3677578866481781, -14.548322677612305, -13.039392471313477,
  -15.139782905578613, -27.22066307067871, -16.533477783203125, -34.16969680786133, -25.079980850219727,
  -31.506994247436523, -36.33536148071289, -25.034406661987305, -41.5117301940918, -24.37764549255371,
  -37.2810173034668, -32.50041580200195, -26.007368087768555, -41.51020431518555, -16.899560928344727,
  -36.34317398071289, -20.347267150878906, -19.19696807861328, -27.362768173217773, 2.2746520042419434,
  -21.63852882385254, 12.747774124145508, 2.212430000305176, 4.170291900634766, 33.15880584716797, -13.489850997924805,
  40.88408660888672, 6.281614780426025, 6.987442493438721, 28.70667839050293, -77.25569152832031, 60.930755615234375,
];
